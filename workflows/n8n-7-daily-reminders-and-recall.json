{
    "nodes": [
        {
            "parameters": {},
            "name": "Manual Trigger",
            "type": "n8n-nodes-base.manualTrigger",
            "typeVersion": 1,
            "position": [
                -1264,
                224
            ],
            "id": "fc77015c-72e1-452d-a7b3-fc60d71a47cd"
        },
        {
            "parameters": {
                "triggerTimes": {
                    "item": [
                        {
                            "hour": 9
                        }
                    ]
                }
            },
            "name": "Cron (Daily 9AM)",
            "type": "n8n-nodes-base.cron",
            "typeVersion": 1,
            "position": [
                -1264,
                -128
            ],
            "id": "ad5d3810-b211-47e3-96ff-e47de4feed3e"
        },
        {
            "parameters": {
                "jsCode": "// Calculate tomorrow's date range for filtering\nconst now = new Date();\nconst tomorrow = new Date(now);\ntomorrow.setDate(tomorrow.getDate() + 1);\n\n// Format as ISO date for Supabase filter\nconst tomorrowStart = tomorrow.toISOString().split('T')[0] + 'T00:00:00';\nconst tomorrowEnd = tomorrow.toISOString().split('T')[0] + 'T23:59:59';\n\nreturn {\n  json: {\n    tomorrow_start: tomorrowStart,\n    tomorrow_end: tomorrowEnd\n  }\n};"
            },
            "name": "Calculate Tomorrow Date",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -1040,
                -176
            ],
            "id": "79c2c694-6f7c-4dbd-ba8b-a615319de829"
        },
        {
            "parameters": {
                "operation": "getAll",
                "tableId": "bookings",
                "returnAll": true,
                "filterType": "string",
                "filterString": "={{ 'and=(status.eq.confirmed,start_time.gte.' + $json.tomorrow_start + ',start_time.lte.' + $json.tomorrow_end + ')' }}"
            },
            "name": "Fetch Tomorrow's Bookings",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                -816,
                -176
            ],
            "id": "eccc5d4f-2979-4150-8402-dfefe7008638",
            "credentials": {
                "supabaseApi": {
                    "id": "dlNOvdwAbyq59XOl",
                    "name": "Supabase account"
                }
            }
        },
        {
            "parameters": {
                "batchSize": 1,
                "options": {}
            },
            "name": "Split Batches",
            "type": "n8n-nodes-base.splitInBatches",
            "typeVersion": 1,
            "position": [
                -592,
                -176
            ],
            "id": "7bbd0b32-3a8c-48a6-9dde-95901b9eca45"
        },
        {
            "parameters": {
                "jsCode": "// Multi-language Logic - Prefer stored language, fallback to phone-based\nconst booking = $input.first().json;\nconst phone = (booking.customer_phone || '').replace(/\\D/g, ''); // Remove non-digits\nconst name = booking.customer_name || 'Pacients';\nconst time = booking.start_time;\nconst serviceName = booking.service_name || 'ZobÄrstniecÄ«bas vizÄ«te';\n\n// Clinic Configuration\nconst CLINIC_ADDRESS = 'Dzirnavu iela 45, Centra rajons, RÄ«ga, LV-1050';\nconst GOOGLE_MAPS_URL = 'https://maps.google.com/?q=Dzirnavu+iela+62A,+Riga,+Latvia';\n\n// Format time and date for display\nlet displayTime = time;\nlet displayDate = '';\nif (time && time.includes('T')) {\n  displayTime = time.split('T')[1].substring(0, 5);\n  const dateObj = new Date(time);\n  const tomorrow = new Date();\n  tomorrow.setDate(tomorrow.getDate() + 1);\n  displayDate = tomorrow.toLocaleDateString('lv-LV', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });\n}\n\n// Language Rule: Prefer stored language, fallback to phone-based detection\nlet lang = (booking.language || '').toLowerCase();\nif (!['lv', 'en', 'ru'].includes(lang)) {\n  const isLatvian = !phone || phone.startsWith('371') || phone.length === 8;\n  lang = isLatvian ? 'lv' : 'en';\n}\n\nlet emailSubject, emailBody, smsMessage;\n\n// HTML Email Styles (shared)\nconst styles = `body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; } .header { background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); color: white; padding: 30px; border-radius: 12px 12px 0 0; text-align: center; } .header h1 { margin: 0; font-size: 24px; } .content { background: #f8fafc; padding: 30px; border-radius: 0 0 12px 12px; } .info-card { background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); } .info-row { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #e2e8f0; } .info-row:last-child { border-bottom: none; } .info-icon { font-size: 20px; margin-right: 12px; } .info-label { color: #64748b; font-size: 14px; } .info-value { font-weight: 600; color: #1e293b; } .reminder-badge { background: #fef3c7; color: #92400e; padding: 12px 20px; border-radius: 8px; text-align: center; margin-bottom: 20px; font-weight: 600; } .btn { display: inline-block; background: #0d9488; color: white !important; padding: 14px 28px; border-radius: 8px; text-decoration: none; font-weight: 600; margin: 10px 5px 10px 0; } .footer { text-align: center; margin-top: 30px; color: #64748b; font-size: 14px; } .tip { background: #ecfdf5; border-left: 4px solid #10b981; padding: 15px; margin: 20px 0; border-radius: 0 8px 8px 0; }`;\n\n// --- LATVIAN ---\nif (lang === 'lv') {\n  emailSubject = `â° AtgÄdinÄjums: VizÄ«te rÄ«t plkst. ${displayTime}`;\n  emailBody = `<!DOCTYPE html><html><head><meta charset=\\\"utf-8\\\"><style>${styles}</style></head><body><div class=\\\"header\\\"><h1>ğŸ¦· VizÄ«tes AtgÄdinÄjums</h1></div><div class=\\\"content\\\"><p>Labdien, <strong>${name}</strong>!</p><div class=\\\"reminder-badge\\\">â° JÅ«su vizÄ«te ir ieplÄnota rÄ«t, plkst. <strong>${displayTime}</strong></div><div class=\\\"info-card\\\"><div style=\\\"font-weight: 600; margin-bottom: 15px; color: #1e293b;\\\">VizÄ«tes informÄcija:</div><div class=\\\"info-row\\\"><span class=\\\"info-icon\\\">ğŸ“…</span><div><span class=\\\"info-label\\\">Datums:</span><br><span class=\\\"info-value\\\">${displayDate}</span></div></div><div class=\\\"info-row\\\"><span class=\\\"info-icon\\\">â°</span><div><span class=\\\"info-label\\\">Laiks:</span><br><span class=\\\"info-value\\\">${displayTime}</span></div></div><div class=\\\"info-row\\\"><span class=\\\"info-icon\\\">ğŸ¥</span><div><span class=\\\"info-label\\\">Pakalpojums:</span><br><span class=\\\"info-value\\\">${serviceName}</span></div></div><div class=\\\"info-row\\\"><span class=\\\"info-icon\\\">ğŸ“</span><div><span class=\\\"info-label\\\">Adrese:</span><br><span class=\\\"info-value\\\"><a href=\\\"${GOOGLE_MAPS_URL}\\\" style=\\\"color: #0d9488;\\\">${CLINIC_ADDRESS}</a></span></div></div></div><div style=\\\"text-align: center;\\\"><a href=\\\"${GOOGLE_MAPS_URL}\\\" class=\\\"btn\\\">ğŸ“ SkatÄ«t KartÄ“</a></div><div class=\\\"tip\\\">ğŸ’¡ <strong>Ieteikums:</strong> LÅ«dzu, ierodieties 5-10 minÅ«tes pirms vizÄ«tes laika.</div><div class=\\\"footer\\\"><p>Ja nepiecieÅ¡ams pÄrcelt vizÄ«ti, lÅ«dzu, sazinieties ar mums nekavÄ“joties.</p><p>Ar cieÅ†u,<br><strong>ButkeviÄa Dental Practice</strong></p></div></div></body></html>`;\n  smsMessage = `AtgÄdinÄjums: ZobÄrsta vizÄ«te rÄ«t plkst. ${displayTime}. Adrese: Dzirnavu iela 45. Uz tikÅ¡anos! - ButkeviÄa Dental`;\n}\n// --- RUSSIAN ---\nelse if (lang === 'ru') {\n  const displayDateRu = new Date().toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });\n  emailSubject = `â° ĞĞ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğµ: Ğ’Ğ¸Ğ·Ğ¸Ñ‚ Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° Ğ² ${displayTime}`;\n  emailBody = `<!DOCTYPE html><html><head><meta charset=\\\"utf-8\\\"><style>${styles}</style></head><body><div class=\\\"header\\\"><h1>ğŸ¦· ĞĞ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğµ Ğ¾ Ğ’Ğ¸Ğ·Ğ¸Ñ‚Ğµ</h1></div><div class=\\\"content\\\"><p>Ğ—Ğ´Ñ€Ğ°Ğ²ÑÑ‚Ğ²ÑƒĞ¹Ñ‚Ğµ, <strong>${name}</strong>!</p><div class=\\\"reminder-badge\\\">â° Ğ’Ğ°Ñˆ Ğ²Ğ¸Ğ·Ğ¸Ñ‚ Ğ·Ğ°Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ½Ğ° <strong>Ğ—ĞĞ’Ğ¢Ğ Ğ</strong></div><div class=\\\"info-card\\\"><div style=\\\"font-weight: 600; margin-bottom: 15px; color: #1e293b;\\\">Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ²Ğ¸Ğ·Ğ¸Ñ‚Ğµ:</div><div class=\\\"info-row\\\"><span class=\\\"info-icon\\\">ğŸ“…</span><div><span class=\\\"info-label\\\">Ğ”Ğ°Ñ‚Ğ°:</span><br><span class=\\\"info-value\\\">Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°</span></div></div><div class=\\\"info-row\\\"><span class=\\\"info-icon\\\">â°</span><div><span class=\\\"info-label\\\">Ğ’Ñ€ĞµĞ¼Ñ:</span><br><span class=\\\"info-value\\\">${displayTime}</span></div></div><div class=\\\"info-row\\\"><span class=\\\"info-icon\\\">ğŸ¥</span><div><span class=\\\"info-label\\\">Ğ£ÑĞ»ÑƒĞ³Ğ°:</span><br><span class=\\\"info-value\\\">${serviceName}</span></div></div><div class=\\\"info-row\\\"><span class=\\\"info-icon\\\">ğŸ“</span><div><span class=\\\"info-label\\\">ĞĞ´Ñ€ĞµÑ:</span><br><span class=\\\"info-value\\\"><a href=\\\"${GOOGLE_MAPS_URL}\\\" style=\\\"color: #0d9488;\\\">${CLINIC_ADDRESS}</a></span></div></div></div><div style=\\\"text-align: center;\\\"><a href=\\\"${GOOGLE_MAPS_URL}\\\" class=\\\"btn\\\">ğŸ“ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ½Ğ° ĞšĞ°Ñ€Ñ‚Ğµ</a></div><div class=\\\"tip\\\">ğŸ’¡ <strong>Ğ¡Ğ¾Ğ²ĞµÑ‚:</strong> ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¸Ñ‚Ğµ Ğ·Ğ° 5-10 Ğ¼Ğ¸Ğ½ÑƒÑ‚ Ğ´Ğ¾ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸.</div><div class=\\\"footer\\\"><p>Ğ•ÑĞ»Ğ¸ Ğ²Ğ°Ğ¼ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¿ĞµÑ€ĞµĞ½ĞµÑÑ‚Ğ¸ Ğ²Ğ¸Ğ·Ğ¸Ñ‚, Ğ¿Ğ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, ÑĞ²ÑĞ¶Ğ¸Ñ‚ĞµÑÑŒ Ñ Ğ½Ğ°Ğ¼Ğ¸ Ğ½ĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾.</p><p>Ğ¡ ÑƒĞ²Ğ°Ğ¶ĞµĞ½Ğ¸ĞµĞ¼,<br><strong>ButkeviÄa Dental Practice</strong></p></div></div></body></html>`;\n  smsMessage = `ĞĞ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğµ: Ğ’Ğ¸Ğ·Ğ¸Ñ‚ Ğº ÑÑ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¾Ğ»Ğ¾Ğ³Ñƒ Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° Ğ² ${displayTime}. ĞĞ´Ñ€ĞµÑ: Dzirnavu iela 45. Ğ”Ğ¾ Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğ¸! - ButkeviÄa Dental`;\n}\n// --- ENGLISH (default) ---\nelse {\n  const displayDateEn = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });\n  emailSubject = `â° Reminder: Appointment Tomorrow at ${displayTime}`;\n  emailBody = `<!DOCTYPE html><html><head><meta charset=\\\"utf-8\\\"><style>${styles}</style></head><body><div class=\\\"header\\\"><h1>ğŸ¦· Appointment Reminder</h1></div><div class=\\\"content\\\"><p>Hi <strong>${name}</strong>,</p><div class=\\\"reminder-badge\\\">â° Your appointment is scheduled for <strong>TOMORROW</strong></div><div class=\\\"info-card\\\"><div style=\\\"font-weight: 600; margin-bottom: 15px; color: #1e293b;\\\">Appointment Details:</div><div class=\\\"info-row\\\"><span class=\\\"info-icon\\\">ğŸ“…</span><div><span class=\\\"info-label\\\">Date:</span><br><span class=\\\"info-value\\\">Tomorrow</span></div></div><div class=\\\"info-row\\\"><span class=\\\"info-icon\\\">â°</span><div><span class=\\\"info-label\\\">Time:</span><br><span class=\\\"info-value\\\">${displayTime}</span></div></div><div class=\\\"info-row\\\"><span class=\\\"info-icon\\\">ğŸ¥</span><div><span class=\\\"info-label\\\">Service:</span><br><span class=\\\"info-value\\\">${serviceName}</span></div></div><div class=\\\"info-row\\\"><span class=\\\"info-icon\\\">ğŸ“</span><div><span class=\\\"info-label\\\">Adrese:</span><br><span class=\\\"info-value\\\"><a href=\\\"${GOOGLE_MAPS_URL}\\\" style=\\\"color: #0d9488;\\\">${CLINIC_ADDRESS}</a></span></div></div></div><div style=\\\"text-align: center;\\\"><a href=\\\"${GOOGLE_MAPS_URL}\\\" class=\\\"btn\\\">ğŸ“ View on Map</a></div><div class=\\\"tip\\\">ğŸ’¡ <strong>Tip:</strong> Please arrive 5-10 minutes before your appointment time.</div><div class=\\\"footer\\\"><p>If you need to reschedule, please contact us immediately.</p><p>Best regards,<br><strong>ButkeviÄa Dental Practice</strong></p></div></div></body></html>`;\n  smsMessage = `Reminder: Dental appointment tomorrow at ${displayTime}. Address: Dzirnavu iela 45. See you soon! - ButkeviÄa Dental`;\n}\n\nreturn {\n  json: {\n    ...booking,\n    email_subject: emailSubject,\n    email_body: emailBody,\n    sms_message: smsMessage\n  }\n};"
            },
            "name": "Language Logic",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -368,
                -240
            ],
            "id": "a97e4f2f-7548-4d56-a730-60b945210676"
        },
        {
            "parameters": {
                "sendTo": "={{$json.customer_email}}",
                "subject": "={{$json.email_subject}}",
                "message": "={{$json.email_body}}",
                "options": {}
            },
            "name": "Send Email (Gmail)",
            "type": "n8n-nodes-base.gmail",
            "typeVersion": 2.1,
            "position": [
                -144,
                -240
            ],
            "id": "783ab6a0-a1dc-4ffe-9b99-53500972caa4",
            "webhookId": "73845e92-cadb-4df5-8272-1aaf250d3b5a",
            "credentials": {
                "gmailOAuth2": {
                    "id": "R3XkS40X8bOhGEL1",
                    "name": "Gmail account 2"
                }
            }
        },
        {
            "parameters": {
                "from": "(952) 952-5258",
                "to": "={{ $('Language Logic').first().json.customer_phone }}",
                "message": "={{ $('Language Logic').first().json.sms_message }}",
                "options": {}
            },
            "name": "Send SMS (Twilio)",
            "type": "n8n-nodes-base.twilio",
            "typeVersion": 1,
            "position": [
                80,
                -176
            ],
            "id": "ad198c4e-0c2b-4415-91bf-9c025c626f83",
            "credentials": {
                "twilioApi": {
                    "id": "Xa4xPKhO4qtTL5X6",
                    "name": "Twilio account"
                }
            },
            "disabled": true
        },
        {
            "parameters": {
                "jsCode": "// Calculate 6-month recall window\nconst now = new Date();\n\n// 6 months ago +/- 7 days\nconst sixMonthsAgo = new Date(now);\nsixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);\n\nconst windowStart = new Date(sixMonthsAgo);\nwindowStart.setDate(windowStart.getDate() - 7);\n\nconst windowEnd = new Date(sixMonthsAgo);\nwindowEnd.setDate(windowEnd.getDate() + 7);\n\nreturn {\n  json: {\n    recall_window_start: windowStart.toISOString(),\n    recall_window_end: windowEnd.toISOString(),\n    current_time: now.toISOString()\n  }\n};"
            },
            "name": "Calculate Recall Window",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -1040,
                176
            ],
            "id": "9be3b368-80c3-4334-b953-4dc3bb47b176"
        },
        {
            "parameters": {
                "operation": "getAll",
                "tableId": "bookings",
                "returnAll": true,
                "filterType": "string",
                "filterString": "={{ 'and=(status.in.(completed,confirmed),start_time.lt.' + $json.current_time + ')' }}"
            },
            "name": "Fetch Past Bookings",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                -816,
                80
            ],
            "id": "95b158a2-1954-4290-bb86-18457fb7d51d",
            "credentials": {
                "supabaseApi": {
                    "id": "dlNOvdwAbyq59XOl",
                    "name": "Supabase account"
                }
            }
        },
        {
            "parameters": {
                "operation": "getAll",
                "tableId": "bookings",
                "returnAll": true,
                "filterType": "string",
                "filterString": "={{ 'and=(status.in.(confirmed,pending),start_time.gt.' + $('Calculate Recall Window').first().json.current_time + ')' }}"
            },
            "name": "Fetch Future Bookings",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                -816,
                272
            ],
            "id": "54c59969-7f13-4ca7-9199-b3beec9ebe10",
            "credentials": {
                "supabaseApi": {
                    "id": "dlNOvdwAbyq59XOl",
                    "name": "Supabase account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// Filter for recall patients:\n// - Last appointment was ~6 months ago (within window)\n// - No future appointments scheduled\n\nconst pastBookings = $('Fetch Past Bookings').all();\nconst futureBookings = $('Fetch Future Bookings').all();\nconst recallWindow = $('Calculate Recall Window').first().json;\n\n// Get emails with future appointments\nconst emailsWithFuture = new Set(\n  futureBookings.map(b => b.json.customer_email?.toLowerCase()).filter(Boolean)\n);\n\n// Group past bookings by email and find last appointment\nconst patientLastAppointment = {};\n\nfor (const booking of pastBookings) {\n  const email = booking.json.customer_email?.toLowerCase();\n  if (!email) continue;\n  \n  const startTime = new Date(booking.json.start_time);\n  \n  if (!patientLastAppointment[email] || startTime > patientLastAppointment[email].date) {\n    patientLastAppointment[email] = {\n      date: startTime,\n      name: booking.json.customer_name,\n      phone: booking.json.customer_phone,\n      email: booking.json.customer_email,\n      language: booking.json.language\n    };\n  }\n}\n\n// Filter for patients in recall window without future appointments\nconst windowStart = new Date(recallWindow.recall_window_start);\nconst windowEnd = new Date(recallWindow.recall_window_end);\n\nconst recallPatients = [];\n\nfor (const [email, data] of Object.entries(patientLastAppointment)) {\n  // Skip if has future appointment\n  if (emailsWithFuture.has(email)) continue;\n  \n  // Check if last appointment is within recall window\n  if (data.date >= windowStart && data.date <= windowEnd) {\n    // Prefer stored language, fallback to phone-based detection\n    let lang = (data.language || '').toLowerCase();\n    if (!['lv', 'en', 'ru'].includes(lang)) {\n      const phone = (data.phone || '').replace(/\\D/g, '');\n      const isLatvian = !phone || phone.startsWith('371') || phone.length === 8;\n      lang = isLatvian ? 'lv' : 'en';\n    }\n    \n    recallPatients.push({\n      json: {\n        patient_email: data.email,\n        patient_name: data.name,\n        language_preference: lang,\n        last_appointment: data.date.toISOString()\n      }\n    });\n  }\n}\n\nreturn recallPatients;"
            },
            "name": "Filter Recall Patients",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -592,
                176
            ],
            "id": "e892d2f1-cf6a-428e-bb1c-e56c4870cdf8"
        },
        {
            "parameters": {
                "batchSize": 10,
                "options": {}
            },
            "id": "ef86f2b1-b1ec-41c6-a866-39029962d67f",
            "name": "Split In Batches",
            "type": "n8n-nodes-base.splitInBatches",
            "typeVersion": 3,
            "position": [
                -368,
                176
            ]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": false,
                        "leftValue": "",
                        "typeValidation": "loose"
                    },
                    "conditions": [
                        {
                            "id": "latvian-check",
                            "leftValue": "={{ $json.language_preference }}",
                            "rightValue": "lv",
                            "operator": {
                                "type": "string",
                                "operation": "equals"
                            }
                        }
                    ],
                    "combinator": "or"
                },
                "options": {}
            },
            "id": "3255cb19-27cf-4ce6-bfdd-a0e215518af1",
            "name": "Check Language",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [
                -144,
                176
            ]
        },
        {
            "parameters": {
                "sendTo": "={{ $json.patient_email }}",
                "subject": "ğŸ¦· Laiks smaida pÄrbaudei â€” 6 mÄ“neÅ¡i jau pagÄjuÅ¡i!",
                "message": "<!DOCTYPE html><html><head><meta charset=\"utf-8\"><style>body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; } .header { background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); color: white; padding: 30px; border-radius: 12px 12px 0 0; text-align: center; } .header h1 { margin: 0; font-size: 24px; } .content { background: #f8fafc; padding: 30px; border-radius: 0 0 12px 12px; } .info-card { background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); } .recall-badge { background: #dbeafe; color: #1e40af; padding: 12px 20px; border-radius: 8px; text-align: center; margin-bottom: 20px; font-weight: 600; } .btn { display: inline-block; background: #0d9488; color: white !important; padding: 14px 28px; border-radius: 8px; text-decoration: none; font-weight: 600; margin: 10px 5px 10px 0; } .footer { text-align: center; margin-top: 30px; color: #64748b; font-size: 14px; } .tip { background: #ecfdf5; border-left: 4px solid #10b981; padding: 15px; margin: 20px 0; border-radius: 0 8px 8px 0; }</style></head><body><div class=\"header\"><h1>ğŸ¦· Laiks Smaida PÄrbaudei!</h1></div><div class=\"content\"><p>Sveiki, <strong>{{ $json.patient_name }}</strong>!</p><div class=\"recall-badge\">ğŸ“… Ir pagÄjuÅ¡i <strong>6 mÄ“neÅ¡i</strong> kopÅ¡ JÅ«su pÄ“dÄ“jÄs vizÄ«tes</div><div class=\"info-card\"><p>Lai smaids bÅ«tu vesels un skaists, zobÄrsti rekomendÄ“ veikt pÄrbaudi un profesionÄlo higiÄ“nu <strong>reizi pusgadÄ</strong>.</p><p>Tas palÄ«dz:</p><ul><li>âœ“ NovÄ“rst kariesu agrÄ«nÄ stadijÄ</li><li>âœ“ SaglabÄt smaganu veselÄ«bu</li><li>âœ“ IzvairÄ«ties no dÄrgÄkas ÄrstÄ“Å¡anas nÄkotnÄ“</li></ul></div><div style=\"text-align: center;\"><a href=\"https://butkevica-dental-booking.pages.dev\" class=\"btn\">ğŸ“… RezervÄ“t VizÄ«ti</a></div><div class=\"tip\">ğŸ’¡ <strong>Ieteikums:</strong> RezervÄ“jiet laiku jau Å¡odien â€” populÄrÄkie laiki aizpildÄs Ätri!</div><div class=\"footer\"><p>Uz drÄ«zu tikÅ¡anos!</p><p>Ar cieÅ†u,<br><strong>ButkeviÄa Dental Practice</strong><br>Dzirnavu iela 62A, RÄ«ga</p></div></div></body></html>",
                "options": {}
            },
            "id": "270662e6-5cdc-4878-974d-e9ba21bb9071",
            "name": "Send Latvian Email",
            "type": "n8n-nodes-base.gmail",
            "typeVersion": 2.1,
            "position": [
                80,
                80
            ],
            "webhookId": "f4a4f24c-9f61-4ce5-8cf3-cded46f2637a",
            "credentials": {
                "gmailOAuth2": {
                    "id": "R3XkS40X8bOhGEL1",
                    "name": "Gmail account 2"
                }
            }
        },
        {
            "parameters": {
                "sendTo": "={{ $json.patient_email }}",
                "subject": "ğŸ¦· Time for Your Smile Check â€” 6 Months Already!",
                "message": "<!DOCTYPE html><html><head><meta charset=\"utf-8\"><style>body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; } .header { background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); color: white; padding: 30px; border-radius: 12px 12px 0 0; text-align: center; } .header h1 { margin: 0; font-size: 24px; } .content { background: #f8fafc; padding: 30px; border-radius: 0 0 12px 12px; } .info-card { background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); } .recall-badge { background: #dbeafe; color: #1e40af; padding: 12px 20px; border-radius: 8px; text-align: center; margin-bottom: 20px; font-weight: 600; } .btn { display: inline-block; background: #0d9488; color: white !important; padding: 14px 28px; border-radius: 8px; text-decoration: none; font-weight: 600; margin: 10px 5px 10px 0; } .footer { text-align: center; margin-top: 30px; color: #64748b; font-size: 14px; } .tip { background: #ecfdf5; border-left: 4px solid #10b981; padding: 15px; margin: 20px 0; border-radius: 0 8px 8px 0; }</style></head><body><div class=\"header\"><h1>ğŸ¦· Time for Your Smile Check!</h1></div><div class=\"content\"><p>Hi <strong>{{ $json.patient_name }}</strong>,</p><div class=\"recall-badge\">ğŸ“… It's been <strong>6 months</strong> since your last visit</div><div class=\"info-card\"><p>For a healthy and beautiful smile, dentists recommend a checkup and professional cleaning <strong>every 6 months</strong>.</p><p>This helps:</p><ul><li>âœ“ Catch cavities early</li><li>âœ“ Maintain healthy gums</li><li>âœ“ Avoid costly treatments later</li></ul></div><div style=\"text-align: center;\"><a href=\"https://butkevica-dental-booking.pages.dev\" class=\"btn\">ğŸ“… Book Your Appointment</a></div><div class=\"tip\">ğŸ’¡ <strong>Tip:</strong> Book today â€” popular time slots fill up quickly!</div><div class=\"footer\"><p>Looking forward to seeing you!</p><p>Best regards,<br><strong>ButkeviÄa Dental Practice</strong><br>Dzirnavu iela 62A, Riga</p></div></div></body></html>",
                "options": {}
            },
            "id": "24efec40-e025-44d9-ab1f-ac73401d656b",
            "name": "Send English Email",
            "type": "n8n-nodes-base.gmail",
            "typeVersion": 2.1,
            "position": [
                80,
                272
            ],
            "webhookId": "ad77de7d-0b77-4711-89fc-30df671b2999",
            "credentials": {
                "gmailOAuth2": {
                    "id": "R3XkS40X8bOhGEL1",
                    "name": "Gmail account 2"
                }
            }
        },
        {
            "parameters": {},
            "id": "50af3b16-48b8-4947-9110-da15f72ef871",
            "name": "Merge Results",
            "type": "n8n-nodes-base.merge",
            "typeVersion": 3,
            "position": [
                304,
                176
            ]
        }
    ],
    "connections": {
        "Manual Trigger": {
            "main": [
                [
                    {
                        "node": "Calculate Recall Window",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Cron (Daily 9AM)": {
            "main": [
                [
                    {
                        "node": "Calculate Tomorrow Date",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Calculate Recall Window",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Calculate Tomorrow Date": {
            "main": [
                [
                    {
                        "node": "Fetch Tomorrow's Bookings",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Fetch Tomorrow's Bookings": {
            "main": [
                [
                    {
                        "node": "Split Batches",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Split Batches": {
            "main": [
                [
                    {
                        "node": "Language Logic",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Language Logic": {
            "main": [
                [
                    {
                        "node": "Send Email (Gmail)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Send Email (Gmail)": {
            "main": [
                [
                    {
                        "node": "Send SMS (Twilio)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Send SMS (Twilio)": {
            "main": [
                [
                    {
                        "node": "Split Batches",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Calculate Recall Window": {
            "main": [
                [
                    {
                        "node": "Fetch Past Bookings",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Fetch Future Bookings",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Fetch Past Bookings": {
            "main": [
                [
                    {
                        "node": "Filter Recall Patients",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Fetch Future Bookings": {
            "main": [
                [
                    {
                        "node": "Filter Recall Patients",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Filter Recall Patients": {
            "main": [
                [
                    {
                        "node": "Split In Batches",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Split In Batches": {
            "main": [
                [
                    {
                        "node": "Check Language",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Check Language": {
            "main": [
                [
                    {
                        "node": "Send Latvian Email",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Send English Email",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Send Latvian Email": {
            "main": [
                [
                    {
                        "node": "Merge Results",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Send English Email": {
            "main": [
                [
                    {
                        "node": "Merge Results",
                        "type": "main",
                        "index": 1
                    }
                ]
            ]
        }
    },
    "pinData": {},
    "meta": {
        "templateCredsSetupCompleted": true,
        "instanceId": "edb1e678c20bb2dc211861028fa5a0da62086103c19f921423bcdc604ef1f332"
    }
}